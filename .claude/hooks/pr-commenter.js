#!/usr/bin/env node

/**
 * Claude Code PR Commenter Hook
 *
 * Automatically posts comments to GitHub PR with summary of:
 * - What prompt was asked
 * - What tools were used (files written/edited)
 * - Brief summary of what was done
 *
 * Usage: Called by PostToolUse hook after significant operations
 */

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

// ============================================================================
// CONFIGURATION
// ============================================================================

const CONFIG = {
  // Tools that trigger PR comments
  significantTools: ['Write', 'Edit', 'Bash'],

  // Minimum tools used before commenting
  minToolsThreshold: 2,

  // Session tracking file
  sessionFile: path.join(process.cwd(), '.claude', 'session-tracking.json'),
};

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================

/**
 * Get current PR number from branch
 */
function getCurrentPR() {
  try {
    const branch = execSync('git branch --show-current', { encoding: 'utf-8' }).trim();

    // Try to find open PR for this branch
    const prs = execSync(`gh pr list --head ${branch} --json number --jq '.[0].number'`, {
      encoding: 'utf-8',
      stdio: ['pipe', 'pipe', 'ignore'] // Suppress stderr
    }).trim();

    return prs ? parseInt(prs) : null;
  } catch (error) {
    return null;
  }
}

/**
 * Load session tracking data
 */
function loadSession() {
  try {
    if (fs.existsSync(CONFIG.sessionFile)) {
      const data = fs.readFileSync(CONFIG.sessionFile, 'utf-8');
      return JSON.parse(data);
    }
  } catch (error) {
    // Ignore errors
  }

  return {
    lastPrompt: '',
    toolsUsed: [],
    filesModified: [],
    startTime: Date.now()
  };
}

/**
 * Save session tracking data
 */
function saveSession(session) {
  try {
    const dir = path.dirname(CONFIG.sessionFile);
    if (!fs.existsSync(dir)) {
      fs.mkdirSync(dir, { recursive: true });
    }
    fs.writeFileSync(CONFIG.sessionFile, JSON.stringify(session, null, 2));
  } catch (error) {
    // Ignore errors
  }
}

/**
 * Clear session data
 */
function clearSession() {
  try {
    if (fs.existsSync(CONFIG.sessionFile)) {
      fs.unlinkSync(CONFIG.sessionFile);
    }
  } catch (error) {
    // Ignore errors
  }
}

/**
 * Format PR comment
 */
function formatPRComment(data) {
  const { prompt, toolsUsed, filesModified, duration } = data;

  const timestamp = new Date().toISOString().replace('T', ' ').substring(0, 19);
  const durationStr = duration > 60000
    ? `${Math.round(duration / 60000)}m`
    : `${Math.round(duration / 1000)}s`;

  let comment = `## ðŸ¤– Claude Code Session Summary\n\n`;
  comment += `**Time:** ${timestamp} (${durationStr})\n\n`;

  // Prompt asked
  comment += `### ðŸ“ Prompt Asked\n\`\`\`\n${prompt.substring(0, 300)}${prompt.length > 300 ? '...' : ''}\n\`\`\`\n\n`;

  // What was done
  comment += `### âœ… What Was Done\n\n`;

  // Group files by operation
  const written = filesModified.filter(f => f.operation === 'Write');
  const edited = filesModified.filter(f => f.operation === 'Edit');
  const commands = toolsUsed.filter(t => t.tool === 'Bash');

  if (written.length > 0) {
    comment += `**Files Created (${written.length}):**\n`;
    written.forEach(f => {
      comment += `- \`${f.file}\`\n`;
    });
    comment += `\n`;
  }

  if (edited.length > 0) {
    comment += `**Files Edited (${edited.length}):**\n`;
    edited.forEach(f => {
      comment += `- \`${f.file}\`\n`;
    });
    comment += `\n`;
  }

  if (commands.length > 0) {
    comment += `**Commands Run (${commands.length}):**\n`;
    commands.slice(0, 5).forEach(c => {
      const cmd = c.description || c.command || 'command';
      comment += `- ${cmd.substring(0, 100)}\n`;
    });
    if (commands.length > 5) {
      comment += `- ... and ${commands.length - 5} more\n`;
    }
    comment += `\n`;
  }

  // Brief summary
  const totalFiles = written.length + edited.length;
  comment += `### ðŸ“Š Summary\n\n`;
  comment += `- **Total files modified:** ${totalFiles}\n`;
  comment += `- **Tools used:** ${toolsUsed.length}\n`;
  comment += `- **Duration:** ${durationStr}\n\n`;

  comment += `---\n`;
  comment += `*Auto-generated by Claude Code PR Commenter*\n`;

  return comment;
}

/**
 * Post comment to PR
 */
function postPRComment(prNumber, comment) {
  try {
    // Write comment to temp file (handles multiline properly)
    const tempFile = path.join('/tmp', `pr-comment-${Date.now()}.md`);
    fs.writeFileSync(tempFile, comment);

    // Post comment using gh CLI
    execSync(`gh pr comment ${prNumber} --body-file ${tempFile}`, {
      encoding: 'utf-8',
      stdio: ['pipe', 'pipe', 'ignore'] // Suppress stderr
    });

    // Clean up temp file
    fs.unlinkSync(tempFile);

    return true;
  } catch (error) {
    console.error(`[pr-commenter] Failed to post comment: ${error.message}`);
    return false;
  }
}

// ============================================================================
// MAIN HOOK LOGIC
// ============================================================================

function main() {
  // Read input from stdin
  let inputData = '';

  try {
    inputData = fs.readFileSync(0, 'utf-8');
  } catch (error) {
    process.exit(0);
  }

  if (!inputData.trim()) {
    process.exit(0);
  }

  try {
    const hookData = JSON.parse(inputData);

    // Get current PR
    const prNumber = getCurrentPR();
    if (!prNumber) {
      // Not on a PR branch, skip
      process.exit(0);
    }

    // Load session data
    const session = loadSession();

    // Check hook event type
    if (hookData.hook_event_name === 'UserPromptSubmit') {
      // User just submitted a prompt - save it
      session.lastPrompt = hookData.prompt || '';
      session.toolsUsed = [];
      session.filesModified = [];
      session.startTime = Date.now();
      saveSession(session);
      process.exit(0);
    }

    if (hookData.hook_event_name === 'PostToolUse') {
      // Tool was just used - track it
      const toolName = hookData.tool_name;

      if (CONFIG.significantTools.includes(toolName)) {
        session.toolsUsed.push({
          tool: toolName,
          description: hookData.description,
          command: hookData.command
        });

        // Track file modifications
        if (toolName === 'Write' || toolName === 'Edit') {
          const filePath = hookData.file_path || hookData.parameters?.file_path || '';
          if (filePath) {
            session.filesModified.push({
              file: path.relative(process.cwd(), filePath),
              operation: toolName
            });
          }
        }

        saveSession(session);
      }

      // Check if we should post a comment (after multiple tools)
      if (session.toolsUsed.length >= CONFIG.minToolsThreshold) {
        const duration = Date.now() - session.startTime;

        // Format and post comment
        const comment = formatPRComment({
          prompt: session.lastPrompt,
          toolsUsed: session.toolsUsed,
          filesModified: session.filesModified,
          duration: duration
        });

        const posted = postPRComment(prNumber, comment);

        if (posted) {
          console.log(`âœ“ Posted session summary to PR #${prNumber}`);
          // Clear session after posting
          clearSession();
        }
      }
    }

  } catch (error) {
    console.error(`[pr-commenter] Error: ${error.message}`);
  }

  process.exit(0);
}

// Run hook
if (require.main === module) {
  main();
}

module.exports = { formatPRComment, getCurrentPR };
